<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MiniCRM v2 ‚Äî SaaS + –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{ --bg:#0b0f14; --panel:#101621; --soft:#0e141d; --glass:rgba(255,255,255,.05);
           --border:#1b2533; --text:#e7eef7; --muted:#9aa7bb; --accent:#19c37d; --warn:#ffb020; --danger:#ff5d5d;
           --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.4); }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0a0e13 60%,#090d12);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    .header{position:sticky;top:0;z-index:20;display:flex;gap:6px;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(11,15,20,.95),rgba(11,15,20,.72))}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#42ffb7,var(--accent));box-shadow:0 0 16px var(--accent)}
    h1{display:none}
    .search{display:flex;gap:8px;align-items:center;margin-left:auto}
    .search input{flex:1;min-width:120px;background:var(--soft);border:1px solid var(--border);border-radius:12px;color:var(--text);padding:6px}
    .badge, .iconbtn{white-space:nowrap;border:1px dashed var(--border);padding:4px 6px;border-radius:10px;color:var(--muted);cursor:pointer;background:var(--glass)}

    .tabs{display:flex;gap:8px;overflow:auto;padding:8px 12px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(13,18,26,.9),rgba(13,18,26,.6))}
    .tab{flex:0 0 auto;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
    .tab.active{color:var(--text);border-color:rgba(25,195,125,.35);background:linear-gradient(180deg,rgba(25,195,125,.14),rgba(25,195,125,.08));box-shadow:0 4px 18px rgba(25,195,125,.16)}

    .page{display:none;min-height:calc(100dvh - 150px);padding:8px}
    .page.active{display:block;animation:fade .18s}
    @keyframes fade{from{opacity:.5;transform:translateY(4px)}to{opacity:1;transform:none}}

    .card{position:relative;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:10px;margin:8px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .title{font-weight:700}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:11px;padding:4px 6px;border-radius:999px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
    .chip.ok{color:#b8f7d9;border-color:rgba(25,195,125,.4)}
    .chip.bad{color:#ffb8b8;border-color:rgba(255,93,93,.4)}
    .card::after{content:"";position:absolute;inset:2px;border-radius:calc(var(--radius) - 2px);pointer-events:none;opacity:.75}
/* —Ç–æ–Ω–∫–∞—è –∫—Ä–∞—Å–Ω–∞—è —Å–≤–µ—Ç—è—â–∞—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ –¥–ª—è –¥–æ–ª–∂–Ω–∏–∫–æ–≤ */
.card.debtor{border-color:rgba(255,32,32,.45)}
.card.debtor::after{box-shadow:0 0 0 0.5px rgba(255,32,32,.7)}
/* hairline –Ω–∞ HiDPI: 1px ‚Üí 0.5px@2x ‚Üí 0.333px@3x */
@media (min-resolution: 2dppx){
  .card.debtor::after{box-shadow:0 0 0 0.25px rgba(255,32,32,.6)}
}
@media (min-resolution: 3dppx){
  .card.debtor::after{box-shadow:0 0 0 0.167px rgba(255,32,32,.55)}
}
/* —Ç–æ–Ω–∫–∞—è –∑–µ–ª—ë–Ω–∞—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ "–í —Ä–∞–±–æ—Ç–µ" (–∫—Ä–æ–º–µ –¥–æ–ª–∂–Ω–∏–∫–æ–≤) */
.card.work{border-color:rgba(25,195,125,.35)}
.card.work:not(.debtor)::after{box-shadow:0 0 0 0.5px rgba(25,195,125,.65)}
@media (min-resolution: 2dppx){ .card.work:not(.debtor)::after{box-shadow:0 0 0 0.25px rgba(25,195,125,.6)} }
@media (min-resolution: 3dppx){ .card.work:not(.debtor)::after{box-shadow:0 0 0 0.167px rgba(25,195,125,.55)} }

/* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö */
/* –ù–∞ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö "–í —Ä–∞–±–æ—Ç–µ" –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –∂—ë—Å—Ç–∫–æ */
.card.work::before{content:none !important}
.card.done::before{content:"";position:absolute;inset:2px;border-radius:calc(var(--radius) - 2px);background:rgba(0,0,0,.38);pointer-events:none}

    .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .kpi{background:linear-gradient(180deg,rgba(25,195,125,.12),rgba(25,195,125,.04));border:1px solid rgba(25,195,125,.35);border-radius:12px;padding:8px}
    .kpi h3{margin:0 0 4px 0;font-size:12px;color:var(--muted)}
    .kpi b{font-size:15px}

    .navbar{position:sticky;bottom:0;z-index:18;border-top:1px solid var(--border);padding:8px;background:linear-gradient(0deg,rgba(9,12,16,.95),rgba(9,12,16,.75))}
    .navrow{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .navbtn{padding:8px;border-radius:12px;border:1px solid var(--border);background:var(--glass);color:var(--muted)}
    .navbtn.active{color:var(--text);border-color:rgba(25,195,125,.35);box-shadow:0 4px 18px rgba(25,195,125,.15)}

    .toast{position:fixed;left:50%;bottom:72px;transform:translateX(-50%);background:#111;color:#fff;border:1px solid #333;padding:8px 10px;border-radius:10px;opacity:0;transition:.2s;pointer-events:none}
    .toast.show{opacity:1}

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .field{display:grid;gap:4px;margin-top:6px}
    .field input,.field textarea,.field select,.field button{padding:8px;border-radius:12px;border:1px solid var(--border);background:var(--soft);color:var(--text);width:100%}
/* –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –≤—ã—Å–æ—Ç –ø–æ–ª–µ–π */
.field input,.field select,.field button{height:42px}
.field textarea{min-height:72px;resize:vertical}

    .subtabs{display:flex;gap:8px;margin:6px 0}
    .subtabs .sub{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:var(--glass);color:var(--muted)}
    .subtabs .sub.active{color:var(--text);border-color:rgba(25,195,125,.35)}

    .blocker{position:fixed;inset:0;background:rgba(11,15,20,.88);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{max-width:520px;margin:12px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px}
/* –º–æ–±–∏–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ */
@media (max-width: 420px){
  .grid2{grid-template-columns:1fr}
  .modal{margin:8px;padding:12px}
  .header{padding:6px 8px}
  .tabs{padding:6px 8px}
  .navbar{padding:6px}
}
    .phone{color:#b8f7d9;text-decoration:none}
  .editor-actions{display:grid;grid-template-columns:1fr 1fr;gap:6px}
/* –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ —É–±–∏—Ä–∞–µ–º –Ω–∏–∂–Ω—é—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª–∞ –∫–Ω–æ–ø–∫–∏ */
body.modal-open .navbar{display:none}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand"><div class="dot"></div></div>
    <div class="search">
      <input id="q" placeholder="–ü–æ–∏—Å–∫: –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω/–º–æ–¥–µ–ª—å, #ID" autocomplete="off" />
      <button class="iconbtn" id="add-new" title="–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç">Ôºã –ù–æ–≤—ã–π</button>
      <div class="badge" id="stat" title="–õ–∏—Ü–µ–Ω–∑–∏—è / –û–ø–ª–∞—Ç–∞">–õ–∏—Ü–µ–Ω–∑–∏—è</div>
    </div>
  </div>

  <div class="tabs" id="tabs">
    <button class="tab active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
    <button class="tab" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
    <button class="tab" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
    <button class="tab" data-page="done">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
    <button class="tab" data-page="admin">–ü–∞–Ω–µ–ª—å</button>
  </div>

  <section class="page active" id="page-home">
    <div class="kpis" id="home-kpis"></div>
    <div id="home-list"></div>
  </section>
  <section class="page" id="page-debts">
    <div id="debts-summary"></div>
    <div id="debts-list"></div>
  </section>
  <section class="page" id="page-work"><div id="work-list"></div></section>
  <section class="page" id="page-done"><div id="done-list"></div></section>

  <section class="page" id="page-admin">
    <div class="card">
      <div class="title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
      <div class="muted" id="tenant-info">–≠–∫–∑–µ–º–ø–ª—è—Ä: ‚Äî</div>
      <div class="subtabs" id="subtabs">
        <button class="sub active" data-sub="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        <button class="sub" data-sub="builder">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü</button>
        <button class="sub" data-sub="publish">–ü—É–±–ª–∏–∫–∞—Ü–∏—è</button>
      </div>
      <div id="sub-settings">
        <div class="grid2">
          <div class="field"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label><input id="cfg-name" placeholder="–û–û–û –£–≥—Ä–∞–†–µ–º–ö–æ–º–ø" /></div>
          <div class="field"><label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω</label><input id="cfg-phone" placeholder="+7 900 000-00-00" /></div>
        </div>
        <div class="grid2">
          <div class="field"><label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label><input id="cfg-pass" type="password" placeholder="demo" /></div>
          <div class="field"><label>–°—Ä–æ–∫ –ª–∏—Ü–µ–Ω–∑–∏–∏ (–¥–Ω–µ–π, –¥–µ–º–æ)</label><input id="cfg-licdays" type="number" value="30" /></div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button id="cfg-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="cfg-reset" style="border-color:#333">–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
        </div>
      </div>
      <div id="sub-builder" style="display:none">
        <div class="field"><label>HTML‚Äë—à–∞–±–ª–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã</label>
          <textarea id="bld-html" rows="8" placeholder="<section>–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</section>"></textarea>
        </div>
        <div class="grid2" style="margin-top:8px">
          <button id="bld-preview">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
          <button id="bld-download">–°–∫–∞—á–∞—Ç—å –∫–∞–∫ HTML</button>
        </div>
        <iframe id="bld-frame" style="width:100%;height:240px;border:1px solid var(--border);border-radius:12px;margin-top:8px"></iframe>
      </div>
      <div id="sub-publish" style="display:none">
        <div class="field"><label>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</label>
          <div class="grid2">
            <button id="exp-json">–°–∫–∞—á–∞—Ç—å JSON –±–∞–∑—ã</button>
            <button id="exp-static">–°–∫–∞—á–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
          </div>
        </div>
        <div class="card" style="margin-top:10px">
          <div class="title">–ö–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</div>
          <ol class="muted">
            <li>–ó–∞–π–¥–∏—Ç–µ –Ω–∞ GitHub ‚Üí New repository ‚Üí –≤–∫–ª—é—á–∏—Ç–µ GitHub Pages.</li>
            <li>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∫–∞—á–∞–Ω–Ω—ã–π <b>index.html</b> (–∏–ª–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞).</li>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É Pages, –¥–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä <code>?tid=–í–ê–®_–ö–û–î</code> –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞.</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <div class="navbar" id="navbar">
    <div class="navrow">
      <button class="navbtn active" data-page="home">–ì–ª–∞–≤–Ω–∞—è</button>
      <button class="navbtn" data-page="debts">–ü—Ä–æ—Å—Ä–æ—á–∫–∞</button>
      <button class="navbtn" data-page="work">–í —Ä–∞–±–æ—Ç–µ</button>
      <button class="navbtn" data-page="done">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
      <button class="navbtn" data-page="admin">–ü–∞–Ω–µ–ª—å</button>
    </div>
  </div>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

  <!-- –õ–∏—Ü–µ–Ω–∑–∏–æ–Ω–Ω—ã–π/–ø–∞—Ä–æ–ª—å–Ω—ã–π –≥–µ–π—Ç -->
  <div class="blocker" id="gate">
    <div class="modal">
      <div class="title">–î–æ—Å—Ç—É–ø –∫ —ç–∫–∑–µ–º–ø–ª—è—Ä—É</div>
      <div class="muted" id="gate-info">–≠–∫–∑–µ–º–ø–ª—è—Ä: ‚Äî</div>
      <div class="field"><label>–ü–∞—Ä–æ–ª—å</label><input id="gate-pass" type="password" placeholder="–≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"></div>
      <div class="grid2" style="margin-top:8px">
        <button id="gate-enter">–í–æ–π—Ç–∏</button>
        <button id="gate-trial">–ü—Ä–æ–±–Ω—ã–π 7 –¥–Ω–µ–π</button>
      </div>
      <div class="muted" id="gate-msg" style="margin-top:6px">‚Äî</div>
    </div>
  </div>

  <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–æ–≤—ã–π/–ø—Ä–∞–≤–∫–∞) -->
  <div class="blocker" id="editor-layer" style="display:none">
    <div class="modal">
      <div class="title" id="ed-title">–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</div>
      <form id="ed-form">
        <input type="hidden" id="ed-id" />
        <div class="grid2">
          <div class="field"><label>–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞</label><input id="ed-name" required placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" /></div>
          <div class="field"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="ed-phone" placeholder="+7 900 000-00-00" inputmode="tel" /></div>
        </div>
        <div class="grid2">
          <div class="field"><label>–ú–æ–¥–µ–ª—å –∞–ø–ø–∞—Ä–∞—Ç–∞</label><input id="ed-device" placeholder="iPhone 11 / Redmi ..." /></div>
          <div class="field"><label>–°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã</label><input id="ed-due" type="date" /></div>
        </div>
        <div class="grid2">
          <div class="field"><label>–†–∞–±–æ—Ç–∞ ‚ÇΩ</label><input id="ed-labor" type="number" value="0" inputmode="numeric" /></div>
          <div class="field"><label>–î–µ—Ç–∞–ª–∏ (—Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å) ‚ÇΩ</label><input id="ed-parts" type="number" value="0" inputmode="numeric" /></div>
        </div>
        <div class="grid2">
          <div class="field"><label>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ ‚ÇΩ</label><input id="ed-paid" type="number" value="0" inputmode="numeric" /></div>
          <div class="field"><label>–°—Ç–∞—Ç—É—Å</label>
            <select id="ed-status"><option value="work">–í —Ä–∞–±–æ—Ç–µ</option><option value="done">–ó–∞–≤–µ—Ä—à—ë–Ω</option></select>
          </div>
        </div>
        <div class="field"><label>–ó–∞–º–µ—Ç–∫–∞ –º–∞—Å—Ç–µ—Ä–∞</label><textarea id="ed-notes" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–∞—è –∑–∞–º–µ—Ç–∫–∞"></textarea></div>
        <div class="editor-actions" style="margin-top:8px">
          <button type="button" id="ed-cancel">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" id="ed-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
        <div class="editor-actions" style="margin-top:8px">
          <button type="button" id="ed-done">–û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º</button>
          <button type="button" id="ed-delete" style="border-color:#8b2b2b;color:#ffb8b8">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

<script>
(function(){
  // ===== —É—Ç–∏–ª–∏—Ç—ã
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const byId=(id)=>document.getElementById(id);
  const fmt=(n)=> new Intl.NumberFormat('ru-RU').format(Math.round(Number(n||0)));
  const money=(n)=> fmt(n)+" ‚ÇΩ";
  const days=(ms)=> Math.ceil(ms/86400000);
  const TID=((new URLSearchParams(location.search).get('tid'))||'default').toLowerCase().replace(/[^a-z0-9_-]/g,'');
  const ns=(k)=>`mcrm.v2.${TID}.${k}`;
  const nowId=()=>"#"+Math.floor(100000+Math.random()*899999);

  // ===== –∫–ª—é—á–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (–∏–∑–æ–ª—è—Ü–∏—è –ø–æ TID)
  const KEYS={ data:ns('data'), cfg:ns('cfg'), lic:ns('lic'), users:ns('users'), sess:ns('sess') };
  const DB={ get(){ try{return JSON.parse(localStorage.getItem(KEYS.data))||[]}catch(e){return[]} }, set(v){ localStorage.setItem(KEYS.data, JSON.stringify(v||[])); } };
  const CFG={ get(){ try{return JSON.parse(localStorage.getItem(KEYS.cfg))||{} }catch(e){return{}} }, set(v){ localStorage.setItem(KEYS.cfg, JSON.stringify(v||{})); } };
  const LIC={ get(){ try{return JSON.parse(localStorage.getItem(KEYS.lic))||{trialStart:null,validUntil:null} }catch(e){return{trialStart:null,validUntil:null}} }, set(v){ localStorage.setItem(KEYS.lic, JSON.stringify(v||{})); } };
  const AUTH={ getUsers(){ try{return JSON.parse(localStorage.getItem(KEYS.users))||[]}catch(e){return[]} }, setUsers(a){ localStorage.setItem(KEYS.users, JSON.stringify(a||[])); }, getSess(){ try{return JSON.parse(sessionStorage.getItem(KEYS.sess))||null}catch(e){return null} }, setSess(v){ sessionStorage.setItem(KEYS.sess, JSON.stringify(v||null)); } };

  // ===== –¥–æ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function compute(it){ const labor=+it.labor||0, parts=+it.parts||0, paid=+it.paid||0; const total=labor+parts; const debt=Math.max(0,total-paid); const dueAt= it.dueAt?+it.dueAt : (it.createdAt?+it.createdAt+3*86400000: Date.now()); const overdueDays=(debt>0 && Date.now()>dueAt)? days(Date.now()-dueAt):0; return {total,debt,dueAt,overdueDays}; }
  function matchQuery(it,q){ if(!q) return true; const src=[it.name,it.phone,it.device,it.id].join(' ').toLowerCase().replace(/[\s\-()]/g,''); const qq=String(q).toLowerCase().replace(/[\s\-()]/g,''); return src.includes(qq)||src.startsWith(qq); }
  function aggregate(list){ let totalDebt=0,totalPaid=0,totalSum=0,inWork=0,done=0,debtors=0; list.forEach(x=>{ const m=compute(x); totalDebt+=m.debt; totalPaid+=+x.paid||0; totalSum+=m.total; inWork+= x.status==='work'?1:0; done+= x.status==='done'?1:0; if(m.debt>0) debtors++; }); return {totalDebt,totalPaid,totalSum,inWork,done,debtors,count:list.length}; }

  // ===== –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ UI
  function toast(msg){ const t=byId('toast'); if(!t) return; t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }
  function card(it){ const m=compute(it); const tel=(it.phone||'').replace(/[^\d+]/g,''); const isDone = (it.status==='done' && m.debt===0);
    const cls = [ (m.debt>0?'debtor':''), (isDone?'done':'work') ].filter(Boolean).join(' ');
    const statusLabel = isDone ? '–ó–∞–≤–µ—Ä—à—ë–Ω' : '–í —Ä–∞–±–æ—Ç–µ'; const overdue = m.debt>0? `‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–∫–∞: ${m.overdueDays} –¥–Ω.` : '‚Ä¢ –ë–µ–∑ –ø—Ä–æ—Å—Ä–æ—á–∫–∏'; return `
    <div class="card ${cls}" data-id="${it.id}">
      <div class="row"><div class="title">${it.name} <span class="muted">${it.id}</span></div></div>
      <div class="row muted" style="margin-top:6px"><a class="phone" href="tel:${tel}">üìû ${it.phone||''}</a><span>‚Ä¢ ${it.device||''}</span><span>‚Ä¢ ${overdue}</span></div>
      <div class="chips">
        <span class="chip">–†–∞–±–æ—Ç–∞: ${money(it.labor||0)}</span>
        <span class="chip">–î–µ—Ç–∞–ª–∏: ${money(it.parts||0)}</span>
        <span class="chip"><b>–ò—Ç–æ–≥–æ: ${money(m.total)}</b></span>
        <span class=\"chip ok\">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞: ${money(it.paid||0)}</span>
        ${m.debt>0? `<span class=\"chip bad\"><b>–î–æ–ª–≥: ${money(m.debt)}</b></span>` : ``}
        <span class=\"chip\">${statusLabel}</span>
      </div>
    </div>`; }

  // ===== —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–æ–≤—ã–π/–ø—Ä–∞–≤–∫–∞)
  function edFill(it){ byId('ed-id').value = it && it.id ? it.id : ''; byId('ed-title').textContent = it? '–ü—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞' : '–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç';
    byId('ed-name').value = it && it.name ? it.name : ''; byId('ed-phone').value = it && it.phone ? it.phone : ''; byId('ed-device').value = it && it.device ? it.device : '';
    byId('ed-labor').value = (it && (it.labor!=null)) ? it.labor : 0; byId('ed-parts').value = (it && (it.parts!=null)) ? it.parts : 0; byId('ed-paid').value = (it && (it.paid!=null)) ? it.paid : 0;
    byId('ed-status').value = it && it.status ? it.status : 'work'; byId('ed-notes').value = it && it.notes ? it.notes : '';
    var due = (it && it.dueAt) ? new Date(it.dueAt) : new Date(Date.now()+3*86400000);
    var d = new Date(due.getFullYear(), due.getMonth(), due.getDate());
    byId('ed-due').valueAsDate = d; byId('editor-layer').style.display='flex'; document.body.classList.add('modal-open'); }
  function edClose(){ byId('editor-layer').style.display='none'; document.body.classList.remove('modal-open'); }
  function edGetPayload(){ var id = byId('ed-id').value || nowId(); var found = DB.get().find(function(x){return x.id===id}); var createdAt = found && found.createdAt ? found.createdAt : Date.now();
    var dd = byId('ed-due').valueAsDate; var dueAt = dd ? new Date(dd.getFullYear(), dd.getMonth(), dd.getDate()).getTime() : Date.now()+3*86400000;
    return { id:id, name: byId('ed-name').value.trim(), phone: byId('ed-phone').value.trim(), device: byId('ed-device').value.trim(),
      labor: +byId('ed-labor').value||0, parts: +byId('ed-parts').value||0, paid: +byId('ed-paid').value||0,
      status: byId('ed-status').value||'work', notes: byId('ed-notes').value.trim(), createdAt: createdAt, dueAt: dueAt } }
  function edSave(){ var a=DB.get(); var p=edGetPayload(); var m=compute(p); if(p.status==='done' && m.debt>0){ p.status='work'; toast('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –ø—Ä–∏ –¥–æ–ª–≥–µ ‚Äî —Å—Ç–∞—Ç—É—Å –æ—Å—Ç–∞–≤–ª–µ–Ω ¬´–í —Ä–∞–±–æ—Ç–µ¬ª'); } var i=a.findIndex(function(x){return x.id===p.id}); if(i>-1){ a[i]=Object.assign({},a[i],p); } else { a.unshift(p); } DB.set(a); toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); edClose(); renderAll(); }
  function edDelete(){ var id=byId('ed-id').value; if(!id) return; DB.set(DB.get().filter(function(x){return x.id!==id})); toast('–£–¥–∞–ª–µ–Ω–æ'); edClose(); renderAll(); }
  function edDone(){ var id=byId('ed-id').value; var a=DB.get(); var i=a.findIndex(function(x){return x.id===id}); if(i>-1){ var m=compute(a[i]); if(m.debt>0){ toast('–ù–µ–ª—å–∑—è –∑–∞–≤–µ—Ä—à–∏—Ç—å: –µ—Å—Ç—å –¥–æ–ª–≥'); return; } a[i].status='done'; DB.set(a); toast('–û—Ç–º–µ—á–µ–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º'); edClose(); renderAll(); } }

  // ===== —Ä–µ–Ω–¥–µ—Ä—ã
  function renderKpis(list){ const a=aggregate(list); const box=byId('home-kpis'); if(!box) return; box.innerHTML = `
    <div class="kpi"><h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3><b>${a.count}</b><div class="muted">–í —Ä–∞–±–æ—Ç–µ: ${a.inWork} ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–æ: ${a.done}</div></div>
    <div class="kpi"><h3>–§–∏–Ω–∞–Ω—Å—ã</h3><b>${money(a.totalPaid)} / ${money(a.totalSum)}</b><div class="muted">–û–±—â–∏–π –¥–æ–ª–≥: <b style="color:var(--warn)">${money(a.totalDebt)}</b></div></div>`; }

  function renderAll(){ const all=DB.get(); const q=byId('q')?.value?.trim()||''; const filtered=all.filter(x=>matchQuery(x,q)); renderKpis(filtered);
    const stat=byId('stat'); if(stat){ const ls=licState(); stat.textContent = ls.status==='ok'?'–õ–∏—Ü–µ–Ω–∑–∏—è':(ls.status==='trial'?'–ü—Ä–æ–±–Ω—ã–π':'–ö—É–ø–∏—Ç—å –¥–æ—Å—Ç—É–ø'); }
    const sorted=[...filtered].sort((x,y)=>{ const mx=compute(x), my=compute(y); const dx=mx.debt>0, dy=my.debt>0; if(dx!==dy) return (dy?1:0)-(dx?1:0); if(dx&&dy && (my.overdueDays||0)!==(mx.overdueDays||0)) return (my.overdueDays||0)-(mx.overdueDays||0); if(x.status!==y.status) return x.status==='work'?-1:1; return (y.createdAt||0)-(x.createdAt||0); });
    const home=byId('home-list'); if(home) home.innerHTML = sorted.map(card).join('') || `<div class=\"card\"><div class=\"muted\">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>`;
    // –¥–µ–±–∏—Ç–æ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ —Å –¥–æ–ª–≥–æ–º
    const onlyDebt=filtered.filter(x=>{ const m=compute(x); return m.debt>0; });
    const dsum=byId('debts-summary'); if(dsum){ const sum=onlyDebt.reduce((s,x)=>s+compute(x).debt,0); dsum.innerHTML=`<div class=\"card\"><div class=\"title\">–ü—Ä–æ—Å—Ä–æ—á–∫–∞ ‚Äî —Å–≤–æ–¥–∫–∞</div><div class=\"chips\"><span class=\"chip bad\">–í—Å–µ–≥–æ –¥–æ–ª–≥: ${money(sum)}</span><span class=\"chip\">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${onlyDebt.length}</span></div></div>`; }
    const dlist=byId('debts-list'); if(dlist) dlist.innerHTML = onlyDebt.map(card).join('') || `<div class=\"card\"><div class=\"muted\">–ù–µ—Ç –¥–æ–ª–∂–Ω–∏–∫–æ–≤ üéâ</div></div>`;
    const w=byId('work-list'); if(w) w.innerHTML = filtered.filter(x=>x.status==='work').map(card).join('') || `<div class=\"card\"><div class=\"muted\">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞–±–æ—Ç</div></div>`;
    const dn=byId('done-list'); if(dn) dn.innerHTML = filtered.filter(x=>x.status==='done' && compute(x).debt===0).map(card).join('') || `<div class=\"card\"><div class=\"muted\">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö</div></div>`;
  }

  // ===== –ª–∏—Ü–µ–Ω–∑–∏—è/–≥–µ–π—Ç/–∞—Ä–µ–Ω–¥–∞
  function licState(){ const l=LIC.get(); const now=Date.now(); if(l.validUntil && l.validUntil>now) return {status:'ok', left:days(l.validUntil-now)}; if(l.trialStart && (l.trialStart+7*86400000)>now) return {status:'trial', left:days(l.trialStart+7*86400000-now)}; return {status:'blocked', left:0}; }
  function ensureTrial(){ const l=LIC.get(); if(!l.trialStart && !l.validUntil){ l.trialStart=Date.now(); LIC.set(l); } }
  async function sha256(s){ const enc=new TextEncoder().encode(s); const buf=await crypto.subtle.digest('SHA-256',enc); return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  function gateShow(msg){ byId('gate').style.display='flex'; byId('gate-msg').textContent=msg||'‚Äî'; byId('gate-pass').value=''; byId('gate-info').textContent=`–≠–∫–∑–µ–º–ø–ª—è—Ä: ${TID}`; }
  async function gateCheck(){ const pass=byId('gate-pass').value.trim(); if(!pass){ byId('gate-msg').textContent='–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å'; return; } const users=AUTH.getUsers(); let ok=false; if(!users.length){ const hash=await sha256('demo'); AUTH.setUsers([{id:'u1',name:'admin',role:'admin',pinHash:hash}]); ok=(await sha256(pass))===hash; } else { ok=(await sha256(pass))===users[0].pinHash; }
    if(ok){ AUTH.setSess({ok:true,tid:TID}); byId('gate').style.display='none'; toast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); renderAll(); } else { byId('gate-msg').textContent='–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'; }
  }
  function ensureAccess(){ const ls=licState(); const sess=AUTH.getSess(); if(ls.status==='blocked'){ gateShow('–õ–∏—Ü–µ–Ω–∑–∏—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ù–∞–∂–º–∏—Ç–µ ¬´–ü—Ä–æ–±–Ω—ã–π 7 –¥–Ω–µ–π¬ª –∏–ª–∏ –∫—É–ø–∏—Ç–µ –¥–æ—Å—Ç—É–ø.'); return false; } if(!sess||!sess.ok){ gateShow('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —ç–∫–∑–µ–º–ø–ª—è—Ä'); return false; } return true; }

  // ===== –ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è redeem (–¥–µ–º–æ +30 –¥–Ω–µ–π)
  async function redeemAndApply(plan='P1M'){
    const l = LIC.get();
    l.validUntil = Date.now() + 30*86400000; // –¥–µ–º–æ-–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
    LIC.set(l);
    toast('–õ–∏—Ü–µ–Ω–∑–∏—è: +30 –¥–Ω–µ–π (–¥–µ–º–æ)');
    renderAll();
  }

  // ===== –ø–∞–Ω–µ–ª—å: —Å–∞–±–≤–∫–ª–∞–¥–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è
  function showSub(which){ ['settings','builder','publish'].forEach(id=>{ byId('sub-'+id).style.display = (id===which?'block':'none'); }); $$('#subtabs .sub').forEach(b=>b.classList.toggle('active', b.dataset.sub===which)); }

  function download(name, content, type='text/html'){
    const blob = new Blob([content], {type});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  // ===== –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
  function seed(){ if(DB.get().length) return; const now=Date.now(); DB.set([
    {id:'#100123',name:'–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤',phone:'+7 900 111-22-33',device:'iPhone 11',labor:3500,parts:4500,paid:2000,status:'work',createdAt:now-3*86400000},
    {id:'#100124',name:'–ú–∞—Ä–∏—è –°–∏–¥–æ—Ä–æ–≤–∞',phone:'+7 999 222-33-44',device:'Redmi Note 10',labor:2500,parts:1800,paid:4300,status:'done',createdAt:now-86400000},
    {id:'#100125',name:'–ê–Ω–¥—Ä–µ–π –ö.',phone:'+7 988 777-55-44',device:'Realme C61',labor:3000,parts:0,paid:0,status:'work',createdAt:now-8*86400000,dueAt:now-2*86400000}
  ]); }

  // ===== –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è / –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
  function navHandler(e){ const b=e.target.closest('[data-page]'); if(!b) return; const p=b.getAttribute('data-page'); $$('.tab').forEach(x=>x.classList.toggle('active',x.dataset.page===p)); $$('.navbtn').forEach(x=>x.classList.toggle('active',x.dataset.page===p)); $$('.page').forEach(x=>x.classList.toggle('active',x.id===`page-${p}`)); renderAll(); }

  function init(){ ensureTrial(); seed(); byId('tenant-info').textContent='–≠–∫–∑–µ–º–ø–ª—è—Ä: '+TID;
    byId('tabs').addEventListener('click',navHandler); byId('navbar').addEventListener('click',navHandler);
    byId('q').addEventListener('input',renderAll);
    // —Å–∞–±–≤–∫–ª–∞–¥–∫–∏ –ø–∞–Ω–µ–ª–∏
    byId('subtabs').addEventListener('click',function(e){ var b=e.target.closest('[data-sub]'); if(!b) return; showSub(b.dataset.sub); });
    // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    byId('cfg-save').addEventListener('click',function(){ Promise.resolve().then(async function(){ var cfg={name:byId('cfg-name').value,phone:byId('cfg-phone').value,licDays:+byId('cfg-licdays').value||30}; CFG.set(cfg); var users=AUTH.getUsers(); if(byId('cfg-pass').value){ var hash=await sha256(byId('cfg-pass').value); AUTH.setUsers([{id:'u1',name:'admin',role:'admin',pinHash:hash}]); }
      var l=LIC.get(); l.validUntil=Date.now()+(cfg.licDays*86400000); LIC.set(l); toast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –ª–∏—Ü–µ–Ω–∑–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∞'); renderAll(); }); });
    byId('cfg-reset').addEventListener('click',function(){ localStorage.removeItem(KEYS.data); seed(); toast('–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'); renderAll(); });
    // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
    byId('bld-preview').addEventListener('click',function(){ var html=byId('bld-html').value||'<section style="padding:10px">–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</section>'; var doc='<!doctype html><meta charset="utf-8"><title>Preview</title>'+html; var f=byId('bld-frame'); var blob=new Blob([doc],{type:'text/html'}); f.src=URL.createObjectURL(blob); setTimeout(function(){URL.revokeObjectURL(f.src)},1000); });
    byId('bld-download').addEventListener('click',function(){ var html=byId('bld-html').value||'<section style="padding:10px">–ü—É—Å—Ç–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</section>'; var doc='<!doctype html><html><head><meta charset="utf-8"><title>Landing</title></head><body>'+html+'</body></html>'; download('landing.html',doc); });
    // —ç–∫—Å–ø–æ—Ä—Ç
    byId('exp-json').addEventListener('click',function(){ download('mcrm-'+TID+'-data.json', JSON.stringify(DB.get(),null,2),'application/json'); });
    byId('exp-static').addEventListener('click',function(){ download('index.html', document.documentElement.outerHTML); });
    // –ª–∏—Ü–µ–Ω–∑–∏—è/–æ–ø–ª–∞—Ç–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫)
    byId('stat').addEventListener('click', () => redeemAndApply('P1M'));
    // –≥–µ–π—Ç
    byId('gate-enter').addEventListener('click',gateCheck);
    byId('gate-trial').addEventListener('click',function(){ var l=LIC.get(); l.trialStart=l.trialStart||Date.now(); LIC.set(l); byId('gate').style.display='none'; toast('–ü—Ä–æ–±–Ω—ã–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'); renderAll(); });
    // —Ä–µ–¥–∞–∫—Ç–æ—Ä
    byId('add-new').addEventListener('click',function(){ edFill(null); });
    byId('ed-cancel').addEventListener('click',edClose);
    byId('ed-form').addEventListener('submit',function(e){ e.preventDefault(); edSave(); });
    byId('ed-delete').addEventListener('click',edDelete);
    byId('ed-done').addEventListener('click',edDone);
    // –æ—Ç–∫—Ä—ã—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –∫–ª–∏–∫—É
    document.body.addEventListener('click',function(e){ var card=e.target.closest('.card[data-id]'); if(!card) return; var id=card.getAttribute('data-id'); var it=DB.get().find(function(x){return x.id===id}); if(it) edFill(it); });
    if(!ensureAccess()) return; renderAll(); }

  // —Å–∞–º–æ—Ç–µ—Å—Ç—ã (–Ω–µ –º–µ–Ω—è—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã)
  (function tests(){ const t=(it)=>{ const l=+it.labor||0, p=+it.parts||0, paid=+it.paid||0; const total=l+p; const debt=Math.max(0,total-paid); return {total,debt}; };
    console.assert(t({labor:2000,parts:1000,paid:500}).total===3000,'total=3000');
    console.assert(t({labor:2000,parts:1000,paid:500}).debt===2500,'debt=2500');
    // –î–æ–ø. —Ç–µ—Å—Ç—ã
    const id = nowId(); console.assert(/^#\d{6}$/.test(id),'id format');
    const m = compute({labor:1000,parts:1000,paid:500,createdAt:Date.now()-5*86400000,dueAt:Date.now()-2*86400000});
    console.assert(m.debt===1500,'debt calc'); console.assert(m.overdueDays>=2,'overdue >= 2');
    console.assert(matchQuery({name:'–ò–≤–∞–Ω',phone:'+7 900',device:'iPhone',id:'#1'}, '–∏–≤'), 'match name');
    // –ù–æ–≤—ã–µ —Ç–µ—Å—Ç—ã (–Ω–µ –ª–æ–º–∞—é—Ç —Å—Ç–∞—Ä—ã–µ)
    console.assert(matchQuery({name:'',phone:'+7 900 111-22-33',device:'',id:'#77'}, '900111'), 'match digits');
    console.assert(compute({labor:1000,parts:500,paid:2000}).debt===0, 'no negative debt');
  })();

  document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init();
})();
</script>
</body>
</html>
